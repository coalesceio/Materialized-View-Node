fileVersion: 1
id: "1"
macroString: |-
  {########################################################################################### 

  Purpose: Determines the correct Snowflake DROP object syntax based on the materialization type. 
  Input: materialization (string): The Snowflake object type to be dropped 

    (e.g., table, view, materialized view, dynamic table, external table). 

    

  Returns: string: The appropriate DROP object keyword with IF EXISTS 

    (e.g., 'table IF EXISTS', 'view IF EXISTS', 'materialized view IF EXISTS'). 

  #############################################################################################} 

  {% macro dropMaterialization(materialization) %} 

      {%- if materialization | lower in ['table', 'transient table','temporary table', 'hybrid table'] -%} 

          TABLE IF EXISTS 

      {%- elif materialization | lower in ['view', 'secure view', 'run view', 'cortex search service'] -%} 

          VIEW IF EXISTS 

      {%- elif materialization | lower in ['dynamic table','transient dynamic table', 'dynamic iceberg table'] -%} 

          DYNAMIC TABLE IF EXISTS 

      {%- elif materialization | lower == 'materialized view' -%} 

          MATERIALIZED VIEW IF EXISTS 

      {%- elif materialization | lower == 'external table' -%} 

          EXTERNAL TABLE IF EXISTS 

      {%- elif materialization | lower == 'iceberg table' -%} 

          ICEBERG TABLE IF EXISTS 

      {%- elif materialization | lower == 'interactive table' -%} 

          INTERACTIVE TABLE IF EXISTS 

      {%- elif materialization | lower == 'stream' -%} 

          STREAM IF EXISTS 

      {%- else -%} 

          TABLE IF EXISTS 

      {%- endif %} 

  {% endmacro %} 

   

  {########################################################################################### 

  Purpose: Generates SQL-commented warnings or UI notifications when a user attempts to  

  change the Node Type or Materialization Type of a node. It identifies  

  critical node configurations (Tasks, Streams, Hybrid Views, Cortex, etc.)  

  that could lead to data loss or broken dependencies if switched. 

   

  Input: None 

   

  Returns: A string containing a SQL comment warning (starting with '-- ⚠️')  

      and/or triggers a stage-level warning UI notification for critical switches. 

  #############################################################################################} 

  {% macro getNodeTypeSwitchWarning() %} 

      {%- if currentState.node.nodeType.split(':::')[-1] in ['300', '301'] -%} 

          {# Current Node Type: Deferred Merge Nodes #} 

          -- ⚠️ Warning: This table may be linked to streams and hybrid views. Any required updates/drops must be handled manually. 

      {%- elif currentState.node.nodeType.split(':::')[-1] in ['549', '550', '154', '155'] -%} 

          {# Current Node Type: Root and Resume Tasks Nodes #} 

          -- ⚠️ Warning: These node types are not ideal for switching, as they may act as root or resume tasks. Changing them may disrupt related tasks, cause inconsistencies, or result in data loss. Any required updates/drops must be handled manually. 

      {%- elif currentState.node.materializationType | lower in ['task'] or currentState.node.nodeType.split(':::')[-1] in ['429', '567'] -%} 

          {# Current Node Type: Tasks Related, Insert or Merge with Task, Document AI Nodes#} 

          -- ⚠️ Warning: Tasks or streams are attached to this node. Changing its type may cause task failures, stream inconsistencies, or data loss. Any required updates/drops must be handled manually. 

      {%- elif currentState.node.materializationType | lower in ['stream'] -%} 

          {# Current Node Type: Stream Nodes #} 

          -- ⚠️ Warning: This is a stream node. Changing its type may cause task failures, stream inconsistencies, or data loss. Any required updates/drops must be handled manually. 

      {%- elif currentState.node.materializationType | lower in ['cortex search service'] -%} 

          {# Current Node Type: Cortex Nodes #} 

          -- ⚠️ Warning: Cortex search service is attached to this node. Changing its type may cause service failures, inconsistencies, or data loss. Any required updates/drops must be handled manually. 

      {%- endif %} 

  {% endmacro %} 
name: macro
type: Macro
